---
title: "Group Assignment 3 - Creative Gaming"
author:
- Section 51
- Gaurav Agrawal, Ajitesh Abhishek, Tarun Joshi
output:
  pdf_document: default
  html_notebook: default
  html_document:
    df_print: paged
---

```{r, include=FALSE}
### Determine notebook defaults:
knitr::opts_chunk$set(echo=TRUE,      # Print all the code in all the chunks
                      warning=FALSE,  # Don't print warning statements
                      message=FALSE,  # Don't print other R output messages
                      comment=NA)     # Helps produce prettier output
```

```{r, echo=FALSE, message = FALSE, warning = FALSE}
### Load packages:
library(gmodels)
library(modelr)
library(janitor)
library(haven)
library(readxl)
library(knitr)
library(psych)
library(statar)
library(tidyverse)
library(mktg482)
library(sjPlot)
library(skimr) 
library(nnet)
library(tictoc)
library(effects)
library(splitstackshape)
library(tools4uplift)
```

### Read in the data:
```{r}
# use load("filename.Rdata") for .Rdata files
data = load("creative_gaming_propensity.Rdata")
```

### Part 1 - Question a
```{r}
cg_ad_random <- cg_ad_treatment[sample_random_30000,]

```

### Part 1 - Question b
```{r}
expdata_stacked <- rbind(cg_organic_control %>% mutate(ad = 0), cg_ad_random %>% mutate(ad = 1))
```


### Part 1 - Question c
```{r}
set.seed(1234)
split.index <- stratified(expdata_stacked, c("ad",
 "converted"), 0.7, bothSets=TRUE)
expdata_stacked.train <- split.index[[1]]
expdata_stacked.test <- split.index[[2]]
```
The training test split is 70:30


### Part 2 
```{r}
fm <- formula(converted ~.)
logit.treat <- glm(fm, data=(expdata_stacked.train%>%filter(ad==1)), family = "binomial")
logit.control <- glm(fm, data=(expdata_stacked.train%>%filter(ad==0)), family = "binomial")
```


```{r}
score_treat <- predict(logit.treat, newdata = expdata_stacked.test, type="response")
score_control <- predict(logit.control, newdata = expdata_stacked.test, type="response")
```

```{r}
expdata_stacked.test <- expdata_stacked.test%>%
  mutate(score_treat = score_treat,
         score_control = score_control,
         score_uplift = score_treat-score_control)
```

```{r}
expdata_stacked.test%>%
  arrange(-score_uplift)%>%
  select(converted, ad, score_treat, score_control, score_uplift)%>%
  head()
```

### Part 3 
```{r}
PerfectTable_uplift <-
  QiniTable(
    expdata_stacked.test,
    treat ="ad",
    outcome="converted",
    prediction = "score_uplift",
    nb.group=20
  )

PerfectTable_uplift
```

```{r}
QiniCurve(PerfectTable_uplift)
```

```{r}
QiniBarPlot(PerfectTable_uplift)
```
As per the plots, we have maximum incremental uplift till 25% (average uplift of 20%). Overall, we see uplift in the 90% of the customers, and for the bottom 10% there is destruction of value.

```{r}
cg_ad_remain <- cg_ad_treatment[-sample_random_30000,] %>%
  mutate(ad=1)

```

```{r}
score_treat <- predict(logit.treat, newdata = cg_ad_remain, type="response")
score_control <- predict(logit.control, newdata = cg_ad_remain, type="response")
```

```{r}
cg_ad_remain <- cg_ad_remain%>%
  mutate(score_treat = score_treat,
         score_control = score_control,
         score_uplift = score_treat-score_control)

```

```{r}
cg_ad_remain%>%
  arrange(-score_uplift)%>%
  select(converted, ad, score_treat, score_control, score_uplift)%>%
  head()

```

```{r}
PerTable_uplift <-
  QiniTable(
    cg_ad_remain,
    treat ="ad",
    outcome="converted",
    prediction = "score_uplift",
    nb.group=20
  )

PerTable_uplift
```

```{r}
PerfTable_propensity <-
QiniTable(
expdata_stacked.test,
treat = "ad",
outcome = "converted",
prediction = "score_treat",
nb.group = 20
)
PerfTable_propensity
```

```{r}
QiniBarPlot(PerfTable_propensity)

```

```{r}
QiniBarPlot2(PerfectTable_uplift, PerfTable_propensity, modelnames = c("Uplift Model", "Propensity Model"))
```